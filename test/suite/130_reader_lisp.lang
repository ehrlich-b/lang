// expect: 42
// Test: V2 lisp-style reader macro
// V2 readers output lang source text, not AST nodes

reader lisp(text *u8) *u8 {
    // Simple parser for "OP a b" -> "(a OP b)"
    var pos i64 = 0;

    // Skip whitespace
    while *(text + pos) == 32 { pos = pos + 1; }

    // Read operator (single char: +, -, *, /)
    var op i64 = *(text + pos);
    pos = pos + 1;

    // Skip whitespace
    while *(text + pos) == 32 { pos = pos + 1; }

    // Read first number into result buffer
    var result *u8 = alloc(64);
    var rp i64 = 0;

    // Start with "("
    *(result + rp) = 40;
    rp = rp + 1;

    // Copy first number
    while *(text + pos) >= 48 && *(text + pos) <= 57 {
        *(result + rp) = *(text + pos);
        rp = rp + 1;
        pos = pos + 1;
    }

    // Add space
    *(result + rp) = 32;
    rp = rp + 1;

    // Add operator
    *(result + rp) = op;
    rp = rp + 1;

    // Add space
    *(result + rp) = 32;
    rp = rp + 1;

    // Skip whitespace in input
    while *(text + pos) == 32 { pos = pos + 1; }

    // Copy second number
    while *(text + pos) >= 48 && *(text + pos) <= 57 {
        *(result + rp) = *(text + pos);
        rp = rp + 1;
        pos = pos + 1;
    }

    // End with ")"
    *(result + rp) = 41;
    rp = rp + 1;

    // Null terminate
    *(result + rp) = 0;

    return result;
}

func main() i64 {
    // "* 6 7" -> "(6 * 7)" -> 42
    return #lisp{* 6 7};
}
